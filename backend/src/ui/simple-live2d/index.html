<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Simple Live2D Viewer</title>
    <!-- Load libraries with version logging -->
    <script>
        console.log('Starting to load libraries...');
    </script>
    <!-- Load in correct order -->
    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/dylanNew/live2d/webgl/Live2D/lib/live2d.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.3/pixi.min.js"></script>
    <!-- Load WebSocket handler before Live2D initialization -->
    <script src="websocket-handler.js"></script>
    <!-- Load message handler -->
    <script src="message-handler.js"></script>
    <!-- Load config manager before Live2D viewer -->
    <script src="config-manager.js"></script>
    <!-- Wait for PIXI to load before loading the display plugin -->
    <script>
        window.onPixiLoaded = () => {
            console.log('PIXI loaded, loading Live2D display...');
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/index.min.js';
            script.onload = () => {
                console.log('Live2D display loaded');
                // Make sure ConfigManager is defined before initializing
                if (window.ConfigManager) {
                    window.initializeLive2D();
                } else {
                    console.error('ConfigManager is not defined. Using fallback initialization.');
                    window.initializeLive2DFallback();
                }
            };
            document.head.appendChild(script);
        };
    </script>

    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #1a1a1a;
            font-family: Arial, sans-serif;
        }
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 0;
        }
        #background-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0.8;
        }
        #live2d-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            z-index: 1;
        }
        .dashboard {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 12px;
            color: white;
            min-width: 300px;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 2;
        }
        .control-group {
            margin: 15px 0;
        }
        .control-group label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        select, input[type="range"] {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            background: #333;
            color: white;
            border: 1px solid #444;
            border-radius: 4px;
        }
        #status {
            margin-top: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.5);
            border-radius: 4px;
        }
        .message-controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.8);
            padding: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            z-index: 2;
        }

        .message-form {
            display: flex;
            gap: 10px;
            flex: 1;
            align-items: center;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid #444;
            background: #333;
            color: white;
            font-size: 16px;
        }

        .control-button {
            padding: 12px;
            border-radius: 8px;
            border: none;
            background: #444;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 44px;
            transition: background 0.2s;
        }

        .control-button:hover {
            background: #555;
        }

        .control-button.active {
            background: #666;
        }

        .control-button i {
            font-size: 20px;
        }

        .attachment-preview {
            display: flex;
            gap: 10px;
            margin-top: 5px;
            flex-wrap: wrap;
        }

        .attachment-item {
            background: #444;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .attachment-item button {
            border: none;
            background: none;
            color: #999;
            cursor: pointer;
            padding: 0 4px;
        }

        #attachment-input {
            display: none;
        }

        .tab-controls {
            margin-bottom: 15px;
            display: flex;
            border-bottom: 1px solid #444;
        }

        .tab-button {
            padding: 10px;
            border: none;
            background: rgba(0,0,0,0.5);
            color: white;
            cursor: pointer;
            transition: background 0.2s;
            flex: 1;
            text-align: center;
        }

        .tab-button.active {
            background: rgba(0,0,0,0.8);
            border-bottom: 2px solid #2a5298;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        /* Chat display styles */
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .chat-header {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .user-message, .ai-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .user-message {
            background: #2a5298;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .ai-message {
            background: #444;
            color: white;
            align-self: flex-start;
            margin-right: auto;
        }
        
        /* Group members display */
        .group-members-list {
            padding: 10px;
            max-height: 200px;
            overflow-y: auto;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .group-header {
            padding: 10px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .group-member {
            padding: 8px;
            border-bottom: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.3);
            border-radius: 8px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-indicator.online {
            background-color: #4CAF50;
            box-shadow: 0 0 5px #4CAF50;
        }
        
        .status-indicator.offline {
            background-color: #F44336;
            box-shadow: 0 0 5px #F44336;
        }
        
        .status-indicator.connecting {
            background-color: #FFC107;
            box-shadow: 0 0 5px #FFC107;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }

        .input-with-button {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .full-width-input {
            flex: 1;
            padding: 8px;
            background: #333;
            color: white;
            border: 1px solid #555;
            border-radius: 4px;
        }
        
        .status-info {
            background: rgba(0,0,0,0.3);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .button-group {
            display: flex;
            gap: 10px;
        }
    </style>
    <!-- Add this before the closing </head> tag -->
    <script src="lip-sync.js"></script>
</head>
<body>
    <div id="background-container">
        <img id="background-image" alt="background">
    </div>
    <div id="live2d-container"></div>
    
    <div class="dashboard">
        <h2>Live2D Model Viewer</h2>
        
        <div class="connection-status">
            <span id="connectionIndicator" class="status-indicator offline"></span>
            <span id="connectionText">Offline</span>
            <button id="reconnectButton" class="control-button" title="Reconnect">
                <i class="fas fa-sync-alt"></i> Reconnect
            </button>
            <span id="connectionPort" class="connection-port"></span>
        </div>

        <div class="tab-controls">
            <button class="tab-button active" data-tab="model">Model</button>
            <button class="tab-button" data-tab="chat">Chat</button>
            <button class="tab-button" data-tab="interaction">Interaction</button>
            <button class="tab-button" data-tab="ai">AI Voice</button>
            <button class="tab-button" data-tab="websocket">WebSocket</button>
        </div>

        <div class="tab-content active" data-tab="model">
            <div class="control-group">
                <label for="modelSelect">Character:</label>
                <select id="modelSelect">
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            
            <div class="control-group">
                <label for="backgroundSelect">Background:</label>
                <select id="backgroundSelect">
                    <option value="">None</option>
                    <!-- Will be populated dynamically -->
                </select>
            </div>
            
            <div class="control-group">
                <label>Scale: <span id="scaleValue">1</span></label>
                <input type="range" id="scaleSlider" min="0.1" max="2" step="0.1" value="1">
            </div>
            
            <div class="control-group">
                <label>Position X: <span id="posXValue">0.5</span></label>
                <input type="range" id="posXSlider" min="0" max="1" step="0.01" value="0.5">
            </div>
            
            <div class="control-group">
                <label>Position Y: <span id="posYValue">0.5</span></label>
                <input type="range" id="posYSlider" min="0" max="1" step="0.01" value="0.5">
            </div>
        </div>

        <!-- Chat tab content -->
        <div class="tab-content" data-tab="chat">
            <div class="chat-header">
                <select id="historySelect">
                    <option value="new">+ Create New Chat</option>
                </select>
                <button id="deleteHistoryBtn" class="control-button" title="Delete current chat">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
            <div id="chatDisplay" class="chat-messages"></div>
            
            <div class="group-header">
                <h3>Group Members</h3>
                <button id="inviteBtn" class="control-button" title="Invite to group">
                    <i class="fas fa-user-plus"></i>
                </button>
            </div>
            <div id="groupMembers" class="group-members-list">
                Not in a group
            </div>
        </div>

        <div class="tab-content" data-tab="interaction">
            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enablePointer" checked>
                    Enable Pointer Interaction
                </label>
            </div>
            
            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enableScroll" checked>
                    Enable Scroll to Resize
                </label>
            </div>
            
            <div class="control-group">
                <label>Scroll Sensitivity: <span id="scrollSensValue">1</span></label>
                <input type="range" id="scrollSensitivity" min="0.1" max="2" step="0.1" value="1">
            </div>

            <div class="config-section">
                <h3>Lip Sync Test</h3>
                <div class="control-group">
                    <button id="testMouthOpen" class="config-button">Test Mouth Open</button>
                    <button id="testMouthClose" class="config-button">Test Mouth Close</button>
                </div>
                <div class="control-group">
                    <label for="mouthTestValue">Mouth Value (0-1):</label>
                    <input type="range" id="mouthTestValue" min="0" max="1" step="0.1" value="0.5">
                    <span id="mouthValueDisplay">0.5</span>
                </div>
            </div>
        </div>

        <div class="tab-content" data-tab="ai">
            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enableAIVoice" checked>
                    Enable AI Voice Response
                </label>
            </div>
            
            <div class="control-group">
                <label class="checkbox-label">
                    <input type="checkbox" id="enableAutoResponse">
                    Auto-Respond to Messages
                </label>
            </div>

            <div class="control-group">
                <label>Voice Volume: <span id="voiceVolumeValue">1.0</span></label>
                <input type="range" id="voiceVolume" min="0" max="1" step="0.1" value="1.0">
            </div>

            <div class="control-group">
                <label>Speaking Rate: <span id="speakingRateValue">1.0</span></label>
                <input type="range" id="speakingRate" min="0.5" max="2" step="0.1" value="1.0">
            </div>
        </div>

        <div class="tab-content" data-tab="websocket">
            <div class="control-group">
                <h3>WebSocket Configuration</h3>
                <label for="wsUrl">WebSocket URL:</label>
                <div class="input-with-button">
                    <input type="text" id="wsUrl" class="full-width-input" value="">
                    <button id="updateWsUrl" class="control-button">Update</button>
                </div>
                <div class="status-info">
                    <p>Current Status: <span id="wsStatus">Disconnected</span></p>
                    <p>Client ID: <span id="clientId">None</span></p>
                </div>
                <div class="button-group">
                    <button id="reconnectWs" class="control-button">Reconnect</button>
                    <button id="testWs" class="control-button">Test Connection</button>
                </div>
            </div>

            <div class="control-group">
                <h3>TTS WebSocket Test</h3>
                <label for="ttsText">Text to speak:</label>
                <div class="input-with-button">
                    <input type="text" id="ttsText" class="full-width-input" value="Hello, this is a test of the TTS WebSocket endpoint.">
                    <button id="testTts" class="control-button">Test TTS</button>
                </div>
            </div>
        </div>

        <div id="status">Select a model to begin</div>
    </div>

    <div class="message-controls">
        <form class="message-form" id="messageForm">
            <button type="button" class="control-button" id="muteButton" title="Toggle Mute">
                <i class="fas fa-microphone"></i>
            </button>
            
            <button type="button" class="control-button" id="handButton" title="Toggle Hand">
                <i class="fas fa-hand-paper"></i>
            </button>
            
            <input type="text" class="message-input" id="messageInput" 
                placeholder="Type your message..." autocomplete="off">
            
            <label class="control-button" for="attachment-input" title="Add Attachment">
                <i class="fas fa-paperclip"></i>
            </label>
            <input type="file" id="attachment-input" multiple>
            
            <button type="submit" class="control-button" title="Send">
                <i class="fas fa-paper-plane"></i>
            </button>
        </form>
    </div>

    <!-- Add Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    
    <!-- Load the Live2D viewer script after WebSocket handler and config manager -->
    <script src="live2d-viewer.js"></script>
    
    <!-- Add event handlers for new UI elements -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Set up history selector
            const historySelect = document.getElementById('historySelect');
            if (historySelect) {
                historySelect.addEventListener('change', (e) => {
                    const selectedValue = e.target.value;
                    if (selectedValue === 'new') {
                        WebSocketHandler.createNewHistory();
                    } else {
                        WebSocketHandler.fetchAndSetHistory(selectedValue);
                    }
                });
            }
            
            // Set up delete history button
            const deleteHistoryBtn = document.getElementById('deleteHistoryBtn');
            if (deleteHistoryBtn) {
                deleteHistoryBtn.addEventListener('click', () => {
                    const historySelect = document.getElementById('historySelect');
                    const selectedValue = historySelect.value;
                    if (selectedValue && selectedValue !== 'new') {
                        if (confirm('Are you sure you want to delete this chat history?')) {
                            WebSocketHandler.deleteHistory(selectedValue);
                        }
                    }
                });
            }
            
            // Set up invite button
            const inviteBtn = document.getElementById('inviteBtn');
            if (inviteBtn) {
                inviteBtn.addEventListener('click', () => {
                    const clientId = prompt('Enter client ID to invite:');
                    if (clientId) {
                        WebSocketHandler.addClientToGroup(clientId);
                    }
                });
            }
            
            // Add tab switching logic
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    // Remove active class from all buttons and contents
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked button and corresponding content
                    button.classList.add('active');
                    document.querySelector(`.tab-content[data-tab="${button.dataset.tab}"]`).classList.add('active');
                });
            });

            // Add this to the existing document ready function
            const testTtsButton = document.getElementById('testTts');
            if (testTtsButton) {
                testTtsButton.addEventListener('click', () => {
                    const ttsTextInput = document.getElementById('ttsText');
                    if (ttsTextInput && ttsTextInput.value) {
                        WebSocketHandler.sendTextToTts(ttsTextInput.value);
                    }
                });
            }
        });
    </script>

    <script>
        // Update connection status indicators
        function updateConnectionStatus(status) {
            const indicator = document.getElementById('connectionIndicator');
            const text = document.getElementById('connectionText');
            
            if (!indicator || !text) return;
            
            indicator.className = 'status-indicator ' + status;
            
            switch(status) {
                case 'online':
                    text.textContent = 'Connected';
                    break;
                case 'offline':
                    text.textContent = 'Disconnected';
                    break;
                case 'connecting':
                    text.textContent = 'Connecting...';
                    break;
            }
        }
        
        // Add event listener for reconnect button
        document.getElementById('reconnectButton').addEventListener('click', () => {
            updateConnectionStatus('connecting');
            WebSocketHandler.init();
        });
        
        // Register connection status handlers
        WebSocketHandler.on('onConnect', () => {
            updateConnectionStatus('online');
        });
        
        WebSocketHandler.on('onDisconnect', () => {
            updateConnectionStatus('offline');
        });
        
        // Initial status
        updateConnectionStatus('connecting');
    </script>
</body>
</html> 